### Техническое задание на реализацию сервиса **StudyPublicator**

---

## 1. Введение

**StudyPublicator** — это сервис для публикации медицинских исследований в облачном хранилище с возможностью их анонимизации, архивации и предоставления пациентам ссылок на их скачивание (например, для передачи другому врачу для получения второго мнения). Сервис поддерживает интеграцию с МИС через JSON API и ручной ввод данных. Данные загружаются из PACS через DICOM Query/Retrieve, обрабатываются и загружаются в облачное хранилище.

---

## 2. Цели проекта

1. Автоматизация процесса публикации медицинских исследований.
2. Обеспечение анонимности данных перед публикацией.
3. Интеграция с существующими системами (МИС, PACS, облачное хранилище).
4. Предоставление удобного интерфейса для мониторинга и управления исследованиями.
5. Реализация механизма ручной публикации исследований.

---

## 3. Функциональные требования

### 3.1. Основной функционал
1. **Получение данных:**
   - Через JSON-запрос от МИС.
   - Через форму в веб-панели (ручной ввод `PID` - ID пациента и `ACSN` - AccessionNumber исследования).

2. **Обработка данных:**
   - Проверка наличия исследования по `ACSN`.
   - Если исследование уже опубликовано, возвращаются существующие ссылки.
   - Если исследование новое, оно добавляется в очередь обработки.

3. **Загрузка из PACS:**
   - Использование DICOM Query/Retrieve для получения исследования.
   - Анонимизация данных.
   - Архивация данных.

4. **Публикация в облаке:**
   - Загрузка архива в облачное хранилище.
   - Генерация ссылки на скачивание архива.

5. **Хранение данных:**
   - Установка даты окончания хранения архива на основе дефолтных значений в конфигурации.
   - Автоматическое удаление исследований после истечения срока хранения.

6. **Веб-панель:**
   - Мониторинг очереди обработки.
   - Работа с опубликованными исследованиями.
   - Форма для ручной публикации.

---

## 4. Требования к архитектуре

### 4.1. Компоненты системы
1. **Backend:**
   - Фреймворк на выбор: FastApi, Django, Express, Spring.
   - Брокер сообщений: Apache Kafka, RabbitMQ.
   - База данных: PostgreSQL.
   - Облачное хранилище: AWS S3 compatible.

2. **Frontend:**
   - Фреймворк на выбор: React.js, Vue, Angular.

3. **Логирование:**
   - Подготовка под ELK Stack:
     - Логи пишутся в формате JSON.
     - Логи отправляются в локальный файл или временный брокер.
     - Развертывание ELK отложено до следующих этапов.

---

## 5. Интерфейсы взаимодействия

### 5.1. Взаимодействие с МИС
- **Протокол:** HTTP REST API.
- **Формат данных:** JSON.
- **Методы:**
  - `POST /publish`: Пример сообщения от МИС для публикации.
    ```json
    {
      "patient_id": "1000001158664",
      "accession_number": "KP125706548L",
      "emk_record_id": "123456",
      "clinic_code": "f_Khimki",
      "service_code": "A01.201.405.002",
      "service_title": "МРТ суставов",
      "study_date": "2025-02-01T16:18:02+03:00",
      "save_till_date": "2025-03-01T00:00:00+03:00"
    }
    ```

### 5.2. Взаимодействие с PACS
- **Протокол:** DICOM Query/Retrieve.
- **Формат данных:** DICOM.
- **Методы:**
  - `C-FIND`: Поиск исследования по `Accession Number`.
  - `C-MOVE`: Загрузка данных исследования.

### 5.3. Взаимодействие с облачным хранилищем
- **Протокол:** HTTPS/S3.
- **Методы:**
  - использование AWS S3 API

---

## 6. Веб-панель

### 6.1. Система авторизации
- **Роли пользователей:**
  - `administrator`: Полные права.
  - `registrator`: Чтение, запись/редактирование для определенных функций.

### 6.2. Панель мониторинга
- **Очередь обработки:**
  - Поля:
    - `task_id`
    - `pid`
    - `acsn`
    - `status`
    - `size`
    - `created_at`
  - Подсветка ошибок.
  - Отображение исследований, добавленных через ручную форму.

### 6.3. Панель исследований
- **Список опубликованных исследований:**
  - Поля:
    - `pid`
    - `emk_record_id`
    - `arch_link`
    - `size`
    - `study_date`
    - `upload_date`
    - `save_till`
  - Фильтрация и сортировка по всем полям, кроме ссылок.

- **Форма ручной публикации:**
  - Поля:
    - `ЭМК пациента` (PID)
    - `AccessionNumber` (ACSN)

- **Редактирование даты хранения:** (вынести из MVP)
  - Кнопка `EDIT` для изменения `SAVE_TILL`.

---

## 7. База данных
- **в PostgreSQL** храним все данные
  - по обмену с МИС
  - ручной публикации
  - взаимодействию с PACS
  - взаимодействию с S3
  - роли и их конфигурация
  - пользователи и их настройки


## 8. Безопасность

1. **Анонимизация данных:**
   - Исследования анонимизируются перед загрузкой в облачное хранилище.

2. **Шифрование:**
   - Исследования не шифруются в облаке, так как они анонимизированы.
   - Исследования доступны без авторизации по прямой ссылке.

3. **Авторизация:**
   - Веб-панель имеет систему ролей и разграничения прав.

---

## 9. Логирование

1. **Формат логов:**
   - JSON.
   - Пример:
     ```json
     {
       "timestamp": "2025-02-01T16:18:02+03:00",
       "level": "INFO",
       "message": "Исследование KP125706548L успешно опубликовано",
       "details": {
         "pid": "1000001158664",
         "acsn": "KP125706548L",
         "status": "COMPLETED"
       }
     }
     ```

2. **Подготовка под ELK:**
   - Логи отправляются в локальный файл или временный брокер.
   - Развертывание ELK отложено до следующих этапов.

---

## 10. План разработки

| Этап                          | Срок выполнения       | Описание                                                                 |
|-------------------------------|-----------------------|-------------------------------------------------------------------------|
| Разработка MVP                | 1 месяц              | Реализация базового функционала и интеграции с МИС и PACS.              |
| Добавление веб-панели         | 1 месяц             | Разработка интерфейса для мониторинга и управления.                     |
| Интеграция с облачным хранилищем | 1 месяц              | Настройка загрузки данных в S3 и генерации ссылок.                      |
| Тестирование и оптимизация    | 2 недели              | Тестирование производительности и безопасности.                        |


---

## 11. Заключение

StudyPublicator предлагает простое и эффективное решение для публикации медицинских исследований. Сервис легко масштабируется, поддерживает интеграцию с современными системами и готов к дальнейшему развитию.
